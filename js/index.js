const secondPreviousDataSet = [
  {
    YR: 2021,
    ID: 606,
    MUNICIPALITY: "Bucks County",
    AMOUNT: 80000,
    PROJECTNAME: "Bucks County Pedestrian Safety Enhancements",
  },
  {
    YR: 2021,
    ID: 661,
    MUNICIPALITY: "Bucks County Planning Commission",
    AMOUNT: 60000,
    PROJECTNAME: "Upper Bucks County Area Public Transportation Analysis",
  },
  {
    YR: 2021,
    ID: 610,
    MUNICIPALITY: "Kennett Square Borough",
    AMOUNT: 80000,
    PROJECTNAME: "Kennett Region Micro-Transit Feasibility",
  },
  {
    YR: 2021,
    ID: 601,
    MUNICIPALITY: "Charlestown Township",
    AMOUNT: 64000,
    PROJECTNAME: "Devault Trail Activation Feasibility",
  },
  {
    YR: 2021,
    ID: 603,
    MUNICIPALITY: "Eddystone Borough",
    AMOUNT: 48000,
    PROJECTNAME: "Route 291 Corridor Improvements",
  },
  {
    YR: 2021,
    ID: 623,
    MUNICIPALITY: "Media Borough",
    AMOUNT: 64000,
    PROJECTNAME: "Hybrid Form-Based Code",
  },
  {
    YR: 2021,
    ID: 602,
    MUNICIPALITY: "Lansdowne Borough",
    AMOUNT: 85000,
    PROJECTNAME: "Eastern Delco Bikeway Prioritization",
  },
  {
    YR: 2021,
    ID: 605,
    MUNICIPALITY: "Upper Gwynedd Township",
    AMOUNT: 113000,
    PROJECTNAME: "Advancing the Liberty Bell Trail",
  },
  {
    YR: 2021,
    ID: 618,
    MUNICIPALITY: "Montgomery County",
    AMOUNT: 90000,
    PROJECTNAME: "Cross County Trail Feasibility",
  },
  {
    YR: 2021,
    ID: 608,
    MUNICIPALITY: "Green Lane Borough",
    AMOUNT: 36000,
    PROJECTNAME:
      "Addressing Active Transportation and Trail-End Revitalization",
  },
  {
    YR: 2021,
    ID: 616,
    MUNICIPALITY: "Whitemarsh Township",
    AMOUNT: 80000,
    PROJECTNAME:
      "Multi-Modal Connections between Washington Street and Spring Mill Station",
  },
  {
    YR: 2021,
    ID: 605,
    MUNICIPALITY: "Philadelphia",
    AMOUNT: 90000,
    PROJECTNAME: "North Philadelphia Transit First Corridor",
  },
  {
    YR: 2021,
    ID: 614,
    MUNICIPALITY: "Philadelphia",
    AMOUNT: 85000,
    PROJECTNAME: "Philadelphia Complete Streets Delivery Program",
  },
  {
    YR: 2021,
    ID: 617,
    MUNICIPALITY: "Philadelphia",
    AMOUNT: 60000,
    PROJECTNAME: "Philadelphia Trail and Sidepath Maintenance",
  },
  {
    YR: 2021,
    ID: 613,
    MUNICIPALITY: "Philadelphia",
    AMOUNT: 65000,
    PROJECTNAME: "25th Street Corridor Concepts",
  },
  {
    YR: 2021,
    ID: 607,
    MUNICIPALITY: "Philadelphia",
    AMOUNT: 100000,
    PROJECTNAME: "Imagine Philadelphia Part 2",
  },
  {
    YR: 2021,
    ID: 619,
    MUNICIPALITY: "Bordentown City",
    AMOUNT: 60000,
    PROJECTNAME: "Developing Streetscape and Parking Enhancements",
  },
  {
    YR: 2021,
    ID: 622,
    MUNICIPALITY: "Pemberton Township",
    AMOUNT: 85000,
    PROJECTNAME: "CR 530-CR 687 Corridor Development",
  },
  {
    YR: 2021,
    ID: 609,
    MUNICIPALITY: "Haddonfield Borough",
    AMOUNT: 164000,
    PROJECTNAME: "Mitigating Stormwater Impacts on the Transportation System",
  },
  {
    YR: 2021,
    ID: 612,
    MUNICIPALITY: "Woodbury City",
    AMOUNT: 74000,
    PROJECTNAME: "Redbank Station Bike/Ped Shed Improvements",
  },
  {
    YR: 2021,
    ID: 611,
    MUNICIPALITY: "Elk Township",
    AMOUNT: 77000,
    PROJECTNAME: "Assessing Alternative Transportation",
  },
  {
    YR: 2021,
    ID: 621,
    MUNICIPALITY: "Trenton City",
    AMOUNT: 90000,
    PROJECTNAME: "TOD Strategic Plan",
  },
  {
    YR: 2021,
    ID: 615,
    MUNICIPALITY: "Hightstown Borough",
    AMOUNT: 50000,
    PROJECTNAME: "Redevelopment Area Circulation Concepts",
  },
];

const previousDataSet = [
  {
    YR: 2023,
    MUNICIPALITY: "Chester County Planning Commission",
    PROJECTNAME: "Public Transportation Plan Update: Phase Two",
    ID: 683,
    AMOUNT: 60000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "City of Philadelphia",
    PROJECTNAME: "Complete Streets Delivery Program: Phase Two",
    ID: 692,
    AMOUNT: 100000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "City of Philadelphia",
    PROJECTNAME: "Preliminary Work for the Comprehensive Plan",
    ID: 690,
    AMOUNT: 100000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "City of Philadelphia",
    PROJECTNAME: "Neighborhood Bikeways",
    ID: 693,
    AMOUNT: 70000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "City of Philadelphia",
    PROJECTNAME: "Complete Streets Corridor Study for Aramingo Avenue",
    ID: 691,
    AMOUNT: 100000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Township of Middletown",
    PROJECTNAME: "Multimodal Improvement Plan",
    ID: 681,
    AMOUNT: 85000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Newtown Borough",
    PROJECTNAME: "Safety and Walkability Review for Multimodal Improvements",
    ID: 682,
    AMOUNT: 65000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Borough of Oxford",
    PROJECTNAME: "SALDO and Zoning Update",
    ID: 684,
    AMOUNT: 100000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Delaware County TMA",
    PROJECTNAME: "Chester Pike Corridor Multi Modal Improvement Study",
    ID: 686,
    AMOUNT: 125000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Delaware County Planning Department",
    PROJECTNAME: "Route 291 Road Diet Study",
    ID: 685,
    AMOUNT: 150000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Lower Salford Township",
    PROJECTNAME: "Feasibility Study for Walkable Lederach",
    ID: 689,
    AMOUNT: 100000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Municipality of Norristown",
    PROJECTNAME: "Redevelopment Area Transportation Study",
    ID: 688,
    AMOUNT: 80000,
  },
  {
    YR: 2023,
    MUNICIPALITY: "Greater Valley Forge TMA",
    PROJECTNAME: "Community Mobility Hub Feasibility Study",
    ID: 687,
    AMOUNT: 65000,
  },
];

const FY24 = [
  {
    YR: 2024,
    MUNICIPALITY: "Mercer County",
    PROJECTNAME: "Johnson Trolley Trail Corridor Study",
    AMOUNT: 175000,
  },
  {
    YR: 2024,
    MUNICIPALITY: "Cross County Connection TMA",
    PROJECTNAME: "BurLink B5 Alternatives Analysis",
    AMOUNT: 100000,
  },
  {
    YR: 2024,
    MUNICIPALITY: "Beverly City",
    PROJECTNAME: "Circulation Plan Element",
    AMOUNT: 75000,
  },
  {
    YR: 2024,
    MUNICIPALITY: "Burlington County",
    PROJECTNAME: "Southern Regional Trails Feasibility Study",
    AMOUNT: 100000,
  },
  {
    YR: 2024,
    MUNICIPALITY: "NJ Transit",
    PROJECTNAME: "Pennsauken Transit Center TOD Study",
    AMOUNT: 100000,
  },
  {
    YR: 2024,
    MUNICIPALITY: "Deptford Township",
    PROJECTNAME: "Bicycle Facility Plan",
    AMOUNT: 50000,
  },
];

// mapped dataset has a much different shape from data displayed in accordions updating/archiving becomes a pain
const currentDataSet = {
  type: "FeatureCollection",
  features: [
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-74.8325937004785, 40.16106520070865],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "D&L Trail Crossing Study",
        MUNICIPALITY: "Multi-municipal (Falls and Bristol Townships)",
        co_name: "Bucks",
        AMOUNT: 100000,
        longitude: -74.8325937005,
        id: 356,
        state: "PA",
        latitude: 40.1610652007,
        proj_desc2: "",
        PROJ_DESC:
          "TCDI funds will be used to study six specific road crossings along the D&L Trail within Falls and Bristol Townships. Current conditions at these locations create conflict between trail users and motorists. The Study will identify and develop safe crossing alternatives, wayfinding recommendations, and actionable steps for implementation.",
      },
      id: 0,
    },
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.34756004655397, 40.4401232638427],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "Quakertown Borough Complete Streets Plan",
        MUNICIPALITY: "Quakertown",
        co_name: "Bucks",
        AMOUNT: 100000,
        longitude: -75.3475600466,
        id: 357,
        state: "PA",
        latitude: 40.4401232638,
        proj_desc2:
          "access for all users, including pedestrians, bicyclists, and motorists.",
        PROJ_DESC:
          "The Plan will identify and recommend elements of Complete Streets that are appropriate for specific corridors within Quakertown Borough that are known to be problematic and unsafe for pedestrians and cyclists. The goal is to improve safe access for all users, including pedestrians, bicyclists, and motorists.",
      },
      id: 1,
    },
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.7987435979579, 39.98798155105647],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "Lincoln Highway Active Transportation Improvement Plan",
        MUNICIPALITY: "Transportation Management Association of Chester County",
        co_name: "Chester",
        AMOUNT: 85000,
        longitude: -75.798743598,
        id: 358,
        state: "PA",
        latitude: 39.9879815511,
        proj_desc2: "",
        PROJ_DESC:
          "Route 30 (Lincoln Highway) is an important transportation corridor throughout Chester County, but also serves as a primary corridor within many of the County’s western communities. The funds will be used to develop a plan that will make Lincoln Highway a safer and more useable corridor for pedestrians, cyclists, and users of public transportation; and a corridor that better connects the communities that exist along it.",
      },
      id: 2,
    },
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.70730063459794, 40.08251246432494],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "Eagle Village Gateways and Mobility Plan",
        MUNICIPALITY: "Upper Uwchlan Township",
        co_name: "Chester",
        AMOUNT: 100000,
        longitude: -75.7073006346,
        id: 359,
        state: "PA",
        latitude: 40.0825124643,
        proj_desc2: "",
        PROJ_DESC:
          "Eagle Village is the historic center for Upper Uwchlan Township. The Township will use these TCDI funds to build on prior efforts to improve walkability in the core by closing gaps in the multimodal network. The Plan will also identify appropriate traffic calming measures, and ways in which to enhance the sense of place within Eagle Village.",
      },
      id: 3,
    },
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.26941977468525, 39.9195674166227],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "MacDade Boulevard Concept Development Study",
        MUNICIPALITY: "Multi-municipal (Collingdale and Darby Boroughs)",
        co_name: "Delaware",
        AMOUNT: 175000,
        longitude: -75.2694197747,
        id: 360,
        state: "PA",
        latitude: 39.9195674166,
        proj_desc2: "",
        PROJ_DESC:
          "Collingdale and Darby Boroughs will use TCDI funds to identify appropriate strategies for improving pedestrian and cyclist safety, and increasing multimodal options along MacDade Boulevard. Strategies may include, but are not limited to, road diets and protected bike lines.",
      },
      id: 4,
    },
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.36814418979104, 40.03200051269969],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "Downtown Wayne Master Plan",
        MUNICIPALITY: "Radnor Township",
        co_name: "Delaware",
        AMOUNT: 100000,
        longitude: -75.3681441898,
        id: 361,
        state: "PA",
        latitude: 40.0320005127,
        proj_desc2: "",
        PROJ_DESC:
          "The Plan will identify multimodal improvements, economic development strategies, and other infrastructure improvements for the Township’s social and economic center, Wayne. The goal is to coordinate the area’s redevelopment, as well as increease safety for cyclists and pedestrians.",
      },
      id: 5,
    },

    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.18019879717662, 40.09896040867198],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "Cheltenham Avenue Road Diet Feasibility Study",
        MUNICIPALITY: "Montgomery County",
        co_name: "Montgomery",
        AMOUNT: 135000,
        longitude: -75.1801987972,
        id: 362,
        state: "PA",
        latitude: 40.0989604087,
        proj_desc2: "",
        PROJ_DESC:
          "Montgomery County, with direct involvement from Cheltenham and Springfield Townships, will develop a road diet feasibility study aimed at improving accommodations for pedestrians and cyclists, and safety for all roadway users; and reducing vehicle speeds along Cheltenham Avenue.",
      },
      id: 6,
    },
    {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [-75.11471784013146, 40.11384950254374],
      },
      properties: {
        yr: 2024,
        PROJECTNAME: "Abington Separated Bike Lanes Action Plan",
        MUNICIPALITY: "Abington Township",
        co_name: "Montgomery",
        AMOUNT: 75000,
        longitude: -75.1147178401,
        id: 363,
        state: "PA",
        latitude: 40.1138495025,
        proj_desc2: "",
        PROJ_DESC:
          "The funds will be used to develop an action plan that will identify and prioritize corridors for separated bike lanes throughout the Township. This will build on prior Township efforts that focused primarily on a network of sharrows and unprotected bike lanes, and better connect the existing bicycle network with the Township’s seven SEPTA stations.",
      },
      id: 7,
    },
    {
      type: "Feature",
      geometry: { type: "Point", coordinates: [-75.09952698, 39.98078434] },
      properties: {
        yr: 2024,
        PROJECTNAME:
          "Philadelphia Complete Streets Area Study: Port Richmond Industrial District and Waterfront",
        MUNICIPALITY: "City of Philadelphia",
        co_name: "Philadelphia",
        AMOUNT: 60000,
        longitude: -75.09952698,
        id: 364,
        state: "PA",
        latitude: 39.98078434,
        proj_desc2: "",
        PROJ_DESC:
          "TCDI funds will be used to develop a conceptual plan for the Port Richmond neighborhood that will incorporate Complete Streets, address accessibility of the Delaware River Trail, and provide site recommendations and best practices for truck routing and overnight parking to reduce impacts on residents.",
      },
      id: 8,
    },
    {
      type: "Feature",
      geometry: { type: "Point", coordinates: [-75.19821305, 39.939724] },
      properties: {
        yr: 2024,
        PROJECTNAME: "34th Street at Grays Ferry Visioning Project",
        MUNICIPALITY: "City of Philadelphia",
        co_name: "Philadelphia",
        AMOUNT: 90000,
        longitude: -75.19821305,
        id: 365,
        state: "PA",
        latitude: 39.939724,
        proj_desc2: "",
        PROJ_DESC:
          "The project will focus on the redesign of two intersections in Grays Ferry, and the stretch of 34th Street that connects them. The goal is to improve safety for pedestrians and cyclists, as well as accommodate truck traffic, while balancing the needs of residents and businesses in the surrounding neighborhood.",
      },
      id: 9,
    },
    {
      type: "Feature",
      geometry: { type: "Point", coordinates: [-75.18308865, 39.95479896] },
      properties: {
        yr: 2024,
        PROJECTNAME: "Intercity Bus Terminal Site Planning Project",
        MUNICIPALITY: "City of Philadelphia",
        co_name: "Philadelphia",
        AMOUNT: 90000,
        longitude: -75.18308865,
        id: 366,
        state: "PA",
        latitude: 39.95479896,
        proj_desc2: "",
        PROJ_DESC:
          "The project will greatly emphasize stakeholder outreach and engagement to evaluate three preidentified potential locations for the intercity bus terminal within the 30th Street Station area. Through a feasibility analysis, a preferred site will be identified, and preliminary designs developed.",
      },
      id: 10,
    },
    {
      type: "Feature",
      geometry: { type: "Point", coordinates: [-75.21085197, 39.94200379] },
      properties: {
        yr: 2024,
        PROJECTNAME:
          "48th & Woodland Playground Area Transportation Safety Study",
        MUNICIPALITY: "City of Philadelphia",
        co_name: "Philadelphia",
        AMOUNT: 90000,
        longitude: -75.21085197,
        id: 367,
        state: "PA",
        latitude: 39.94200379,
        proj_desc2: "",
        PROJ_DESC:
          "The confluence of various transit modes and a complicated street network in this area create challenges for multimodal options, concerns regarding pedestrian and cyclist safety, and serve as barriers to access. The effort will provide a plan for short, medium, and long-term implementation of strategies that will improve the quality of life of residents in the surrounding neighborhood, and increase safety among multimodal options.",
      },
      id: 11,
    },
    // Add NJ here
    {
      geometry: {
        type: "Point",
        coordinates: [-74.92232840965741, 40.065207435503304],
      },
      type: "Feature",
      id: 0,
      properties: {
        PROJECTNAME: "Transit Village and Land Use Plan",
        MUNICIPALITY: "Beverly City",
        co_name: "Burlington",
        AMOUNT: 90000,
        longitude: -74.9223284097,
        id: 368,
        state: "NJ",
        latitude: 40.0652074355,
        yr: 2026,
        PROJ_DESC2:
          "The scope will include developing a land use plan that will foster transit-oriented development, while leveraging the city’s location along NJ Transit’s River Line.",
        PROJ_DESC:
          "TCDI funds will be used to advance Beverly City’s efforts of becoming a transit village and increase access to housing and jobs by enabling mixed-used commercial and residential development.The scope will include developing a land use plan that will foster transit-oriented development, while leveraging the city’s location along NJ Transit’s River Line.",
      },
    },
    {
      geometry: {
        type: "Point",
        coordinates: [-74.8631747717932, 40.06708614858715],
      },
      type: "Feature",
      id: 6,
      properties: {
        PROJECTNAME:
          "Delaware River Heritage Trail (DRHT) Feasibility and Route Alignment Study",
        MUNICIPALITY:
          "Burlington County Project (Beverly City, Burlington City, Burlington Township, Delanco Township, Edgewater Park Township, and Florence Township)",
        co_name: "Burlington",
        AMOUNT: 75000,
        longitude: -74.8631747718,
        id: 369,
        state: "NJ",
        latitude: 40.0670861486,
        yr: 2026,
        PROJ_DESC2:
          "a 13-mile-long segment of the DRHT and explore ways to eliminate physical barriers.",
        PROJ_DESC:
          "The goal for this project is to identify feasible alignments of the Delaware River Heritage Trail (DRHT) that will link separated communities from Florence to Delanco Townships along a 13-mile-long segment of the DRHT and explore ways to eliminate physical barriers.",
      },
    },
    {
      geometry: {
        type: "Point",
        coordinates: [-74.89465327460098, 39.86681993773317],
      },
      type: "Feature",
      id: 1,
      properties: {
        PROJECTNAME: "Circulation Plan Improvements",
        MUNICIPALITY: "Evesham Township",
        co_name: "Burlington",
        AMOUNT: 75000,
        longitude: -74.8946532746,
        state: "NJ",
        latitude: 39.8668199377,
        yr: 2026,
        id: 370,
        PROJ_DESC:
          "Funding will be used to develop a circulation plan to advance township-wide mobility improvements aimed at enhancing connectivity and improving wayfinding and access to transit.",
      },
    },
    {
      geometry: {
        type: "Point",
        coordinates: [-75.05369705936836, 39.906666392891516],
      },
      type: "Feature",
      id: 2,
      properties: {
        PROJECTNAME: "Zoning & Land Development Ordinance Update",
        MUNICIPALITY: "Haddon Township",
        co_name: "Camden",
        AMOUNT: 60000,
        longitude: -75.0536970594,
        id: 371,
        state: "NJ",
        latitude: 39.9066663929,
        yr: 2026,
        PROJ_DESC2:
          "and enable mixed-use redevelopment of the area surrounding the PATCO High Speed Line station.",
        PROJ_DESC:
          "In order to advance Township efforts to meet affordable housing applications, TCDI funds will be use to update the Township’s land development and zoning ordinance to foster transit-oriented development (TOD) and enable mixed-use redevelopment of the area surrounding the PATCO High Speed Line station.",
      },
    },
    {
      geometry: {
        type: "Point",
        coordinates: [-75.04384006267034, 39.98247764242342],
      },
      type: "Feature",
      id: 3,
      properties: {
        PROJECTNAME: "Pennsauken-Palmyra Trail Expansion Feasibility Study",
        MUNICIPALITY: "Pennsauken Township and Palmyra Borough",
        co_name: "Camden",
        AMOUNT: 125000,
        longitude: -75.0438400627,
        id: 374,
        state: "NJ",
        latitude: 39.9824776424,
        yr: 2026,
        PROJ_DESC2:
          "The goal being to advance efforts to complete the region’s Circuit Trails network and the East Coast Greenway.",
        PROJ_DESC:
          "This multimunicipal effort will identify alignments through Pennsauken Township, in Camden County, and Palmyra Borough, in Burlington County, for a stretch of the Delaware River Heritage Trail.The goal being to advance efforts to complete the region’s Circuit Trails network and the East Coast Greenway.",
      },
    },
    {
      geometry: {
        type: "Point",
        coordinates: [-74.5259309716541, 40.26872772772394],
      },
      type: "Feature",
      id: 4,
      properties: {
        PROJECTNAME: "Downtown Parking and Economic Development Plan",
        MUNICIPALITY: "Hightstown Borough",
        co_name: "Mercer",
        AMOUNT: 75000,
        longitude: -74.5259309717,
        id: 372,
        state: "NJ",
        latitude: 40.2687277277,
        yr: 2026,
        PROJ_DESC2:
          ", while also understanding parking availability versus demand.",
        PROJ_DESC:
          "With the goal of creating a more vibrant downtown that better serves the changing population and addresses access issues, the Borough will use TCDI funds to develop strategies to increase economic activity in downtown, while also understanding parking availability versus demand.",
      },
    },
    {
      geometry: {
        type: "Point",
        coordinates: [-74.76265131226208, 40.21981818620881],
      },
      type: "Feature",
      id: 5,
      properties: {
        PROJECTNAME: "Trenton Transit Center TOD Study",
        MUNICIPALITY: "NJ Transit (Trenton)",
        co_name: "Mercer",
        AMOUNT: 100000,
        longitude: -74.7626513123,
        id: 373,
        state: "NJ",
        latitude: 40.2198181862,
        yr: 2026,
        PROJ_DESC2:
          "The goal is to advance state-level economic and environmental goals and increase City of Trenton’s tax-base by increasing multimodal access to housing and jobs.",
        PROJ_DESC:
          "TCDI funds will be used to study the feasibility transit-oriented development within a half-mile radius of the Trenton Transit Center and identify appropriate transit-friendly improvements.The goal is to advance state-level economic and environmental goals and increase City of Trenton’s tax-base by increasing multimodal access to housing and jobs.",
      },
    },
  ],
};

// Accordion functionality
const accordion = document.querySelectorAll(".accordion");
for (var i = 0; i < accordion.length; i++) {
  accordion[i].onclick = function () {
    // show/hide the accordions on click
    this.classList.toggle("active");

    // toggle the aria-expanded attribute of the accordion button
    let ariaExpandedBool = this.getAttribute("aria-expanded");
    ariaExpandedBool === "false"
      ? (ariaExpandedBool = "true")
      : (ariaExpandedBool = "false");
    this.setAttribute("aria-expanded", ariaExpandedBool);

    // toggle the aria-hidden attribute of the accordion panel
    const panel = this.nextElementSibling;
    let ariaHiddenBool = panel.getAttribute("aria-hidden");
    ariaHiddenBool === "false"
      ? (ariaHiddenBool = "true")
      : (ariaHiddenBool = "false");
    panel.setAttribute("aria-hidden", ariaHiddenBool);

    // show/hide the panel on click
    if (panel.style.maxHeight) {
      panel.style.maxHeight = null;
    } else {
      panel.style.maxHeight = panel.scrollHeight + "px";
    }
  };
}

const getWebLinks = async (year) => {
  const stream = await fetch(
    `https://apps.dvrpc.org/ords/tcdi_db/deliverablefiles?year=${year}`,
  );

  let output = {};

  // check if the ID yields a response
  if (stream.ok) {
    const response = await stream.json();
    response.items.forEach((file) => {
      const id = file.properties.project;
      const link = file.webViewLink;

      // format response so that lookup time for the datasets loop is faster (only looping thru response once here, rather than for every dataset obj)
      output[id] = link;
    });
  } else {
    return null;
  }

  return output;
};

const makeTheRest = (props, table) => {
  const newRow = table.insertRow();
  const municipalityColumn = newRow.insertCell();
  const titleColumn = newRow.insertCell();
  const amountColumn = newRow.insertCell();

  const municipality = props["MUNICIPALITY"];
  const title = props["PROJECTNAME"];
  const amount = props["AMOUNT"].toLocaleString();

  municipalityColumn.textContent = municipality;

  amountColumn.textContent = "$" + amount;
  amountColumn.style.textAlign = "right";

  return [title, titleColumn];
};

const populateProjectDetails = function (dataset, tableName) {
  let isCurrent = false;

  // handle the currentDataSet being a geoJSON vs the rest being regular JSONs
  if (tableName === "currentDataSet") {
    dataset = dataset.features;
    isCurrent = dataset[0].properties.yr;
  }

  const table = document.querySelector("#" + tableName);
  const year = isCurrent || dataset[0]["YR"];
  const yearShort = year - 2000;

  // fill out the awards header
  const awardsHeader = document.querySelector("h2." + tableName);
  awardsHeader.textContent = isCurrent
    ? "FY25 PA & FY26 NJ TCDI Awards"
    : "FY" + year + " TCDI Awards";

  // fill out the accordion header & get links where applicable
  let response;
  if (tableName != "currentDataSet") {
    const accordionButton = document.querySelector("." + tableName);
    accordionButton.textContent = "FY " + year;
    response = getWebLinks(year);
  }

  // function to iterate over datasets so that the if(response) on line 130 can be DRY
  const populateListItems = function (response) {
    dataset.forEach(function (project) {
      let link;

      // grab the link from the response OR get the correct project format if iterating over the currentDataSet geoJSON (current data set will never have links b/c no deliverables yet)
      if (response) {
        const id = project["ID"];
        link = response[id] || null;
      } else {
        project = project.properties;
      }

      let [title, titleColumn] = [...makeTheRest(project, table)];

      // add links wherever they exist, otherwise just add text
      if (link) {
        titleColumn.innerHTML =
          "<a href=" + link + " rel='external'>" + title + "</a>";
      } else {
        titleColumn.textContent = title;
      }
    });
  };

  if (response) {
    response.then(function (responseProjects) {
      populateListItems(responseProjects);
    });
  } else {
    populateListItems(null);
  }
};

populateProjectDetails(currentDataSet, "currentDataSet");
populateProjectDetails(FY24, "FY24");
populateProjectDetails(previousDataSet, "previousDataSet");
populateProjectDetails(secondPreviousDataSet, "secondPreviousDataSet");

mapboxgl.accessToken =
  "pk.eyJ1IjoiY3J2YW5wb2xsYXJkIiwiYSI6ImNseHVpZmprazI4bWoycXB2MTljMWF1YjUifQ.jLMaSXqIUV5N2IxYlk5ZiQ";

const stylesheet = {
  version: 8,
  sources: {
    counties: {
      type: "vector",
      url: "https://tiles.dvrpc.org/data/dvrpc-municipal.json",
    },
  },
  layers: [
    {
      id: "county-fill",
      type: "fill",
      source: "counties",
      "source-layer": "county",
      layout: {},
      paint: {
        "fill-color": "#B6C1C6",
        "fill-opacity": 1,
      },
      filter: ["==", "dvrpc", "Yes"],
    },
    {
      id: "municipality-outline",
      type: "line",
      source: "counties",
      "source-layer": "municipalities",
      paint: {
        "line-width": 0.5,
        "line-color": "#efefef",
      },
    },
    {
      id: "county-outline",
      type: "line",
      source: "counties",
      "source-layer": "county",
      paint: {
        "line-width": 2.5,
        "line-color": "#fff",
      },
      filter: ["==", "dvrpc", "Yes"],
    },
  ],
};

const map = new mapboxgl.Map({
  container: "map",
  style: stylesheet,
  attributionControl: false,
  center: [-75.2273, 40.071],
  minZoom: 7.75,
  maxZoom: 12,
  zoom: 8.82,
});

map.fitBounds([
  [-76.09405517578125, 39.49211914385648],
  [-74.32525634765625, 40.614734298694216],
]);

// define the max and min awards and radii for mapboxGl to consume
const awards = currentDataSet.features.map(function (project) {
  return project.properties.AMOUNT;
});

const maxAward = Math.max.apply(null, awards);
const minAward = Math.min.apply(null, awards);

const maxRadius = 25;
const minRadius = 5;

const award_layer = function (id) {
  return {
    id: id,
    type: "circle",
    source: id,
    paint: {
      "circle-radius": {
        property: "AMOUNT",
        type: "exponential",
        stops: [
          [minAward, minRadius],
          [maxAward, maxRadius],
        ],
      },
      "circle-color": "#6fb8b9",
      "circle-opacity": 0.7,
      "circle-stroke-width": 1.25,
      "circle-stroke-color": "#fff",
      "circle-stroke-opacity": 0.7,
    },
  };
};

const award_hover = function (id, source) {
  return {
    id: id,
    type: "circle",
    source: source,
    paint: {
      "circle-radius": {
        property: "AMOUNT",
        type: "exponential",
        stops: [
          [minAward, minRadius],
          [maxAward, maxRadius],
        ],
      },
      "circle-color": "#6fb8b9",
      "circle-opacity": 1,
      "circle-stroke-width": 1.5,
      "circle-stroke-color": "#fff",
      "circle-stroke-opacity": 1,
    },
    filter: ["==", "ID", ""],
  };
};

const popupDetails = function (e) {
  new mapboxgl.Popup({
    closebutton: true,
    closeOnClick: true,
  })
    .setLngLat(e.features[0].geometry.coordinates)
    .setHTML(
      "<strong>" +
        e.features[0].properties.PROJECTNAME +
        "</strong>" +
        "<br /><em>Award Amount: </em>$" +
        e.features[0].properties.AMOUNT.toLocaleString() +
        "<hr class='popup-hr' />" +
        e.features[0].properties.PROJ_DESC,
    )
    .addTo(map);
};

const legend = document.querySelector("#legend-labels");
const legendSizes = [
  { size: 25, class: "large" },
  { size: 15, class: "medium" },
  { size: 5, class: "small" },
];

const rateOfChange = (maxRadius - minRadius) / (maxAward - minAward);
const radiusAtZero = maxRadius - rateOfChange * maxAward;

const roundfive = function (num) {
  return num % 5 >= 2.5 ? parseInt(num / 5) * 5 + 5 : parseInt(num / 5) * 5;
};

const awardSize = function (circleRadius) {
  let awardVal = (circleRadius - radiusAtZero) / rateOfChange;
  let label = "$" + roundfive(awardVal).toLocaleString();
  return label;
};

legendSizes.forEach(function (circle) {
  let labelText = awardSize(circle.size);
  legend.insertAdjacentHTML(
    "beforeend",
    "<p class='leg-label'" + circle.class + ">" + labelText + "</p>",
  );
});

map.on("load", function () {
  map.addSource("current-year-awards", {
    type: "geojson",
    data: currentDataSet,
  });
  map.addLayer(award_layer("current-year-awards"));
  map.addLayer(award_hover("current-year-hover", "current-year-awards"));

  map.on("click", "current-year-awards", function (e) {
    popupDetails(e);
  });
  map.on("mousemove", "current-year-awards", function (e) {
    map.getCanvas().style.cursor = "pointer";
    map.setFilter("current-year-hover", [
      "==",
      "ID",
      e.features[0].properties["ID"],
    ]);
  });
  map.on("mouseleave", "current-year-awards", function (e) {
    map.getCanvas().style.cursor = "";
    map.setFilter("current-year-hover", ["==", "ID", ""]);
  });
});
